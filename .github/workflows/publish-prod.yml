name: Publish production

on:
  workflow_dispatch:

  push:
    tags:
      - "v*"

  schedule:
    - cron: "0 0 * * *"

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish-ovh:
    runs-on: ubuntu-22.04
    steps:
      - id: get_latest_tag
        uses: oprypin/find-latest-tag@v1
        with:
          repository: okp4/okp4-web

      - uses: actions/checkout@v3
        with:
          ref: ${{ steps.get_latest_tag.outputs.tag }}

      - name: Setup node environment (for building)
        uses: actions/setup-node@v3
        with:
          node-version: 18.13.0

      - name: Fetch dependencies
        run: |
          yarn --frozen-lockfile

      - name: Build
        run: |
          yarn build

      - name: Replace environment config
        working-directory: .github
        run: |
          cp environments/prod/env.js ../public/scripts/

      - name: Copy apache specific configuration
        working-directory: .github
        run: |
          cp environments/prod/.htaccess ../public/

      - name: Copy build output to OVH machine
        uses: garygrossgarten/github-action-scp@v0.8.0
        with:
          host: ${{ secrets.OKP4_OVH_SSH_HOST }}
          username: ${{ secrets.OKP4_OVH_SSH_USERNAME }}
          password: ${{ secrets.OKP4_OVH_SSH_PASSWORD }}
          port: ${{ secrets.OKP4_OVH_SSH_PORT }}
          local: "public"
          remote: ${{ secrets.OKP4_OVH_SSH_PATH }}
